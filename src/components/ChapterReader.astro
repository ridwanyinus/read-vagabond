---
export interface Props {
  volume: number;
  pageCount: number;
  nextChapter: number | null;
  prevChapter: number | null;
}

const { volume, pageCount, nextChapter, prevChapter } = Astro.props;
---

<script define:vars={{ volume, pageCount, nextChapter, prevChapter }}>
  const pages = document.querySelectorAll("img[data-page]");
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");
  const pageCounter = document.getElementById("pageCounter");
  const topBar = document.getElementById("topBar");
  const keyboardHint = document.getElementById("keyboardHint");

  let currentPage = 0;
  let hideTimeout;
  let lastScrollTop = 0;

  const updateNavbar = () => {
    pageCounter.textContent = `Pg. ${currentPage + 1} / ${pageCount}`;
    progressFill.style.width = `${(currentPage / pageCount) * 100}%`;
  };

  const hideNavbar = () => {
    topBar.classList.add("-translate-y-full");
    progressBar.classList.add("-translate-y-24");
  };

  const showNavbar = () => {
    topBar.classList.remove("-translate-y-full");
    progressBar.classList.remove("-translate-y-24");
  };

  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const middlePoint = scrollTop + windowHeight / 2;

    pages.forEach((page, index) => {
      const rect = page.getBoundingClientRect();
      const pageMiddle = rect.top + window.scrollY + rect.height / 2;

      if (Math.abs(middlePoint - pageMiddle) < rect.height / 2) {
        if (currentPage !== index) {
          currentPage = index;
          updateNavbar();
        }
      }
    });

    if (scrollTop < lastScrollTop) {
      showNavbar();
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(hideNavbar, 3000);
    } else {
      hideNavbar();
    }

    lastScrollTop = scrollTop;
  });

  document.addEventListener("mousemove", () => {
    showNavbar();
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(hideNavbar, 3000);
  });

  const scrollToPage = (index) => {
    if (index < 0 || index >= pages.length) return;

    window.scrollTo({
      top: pages[index].offsetTop,
      behavior: "smooth",
    });

    currentPage = index;
    updateNavbar();
  };

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "ArrowRight") {
      e.preventDefault();
      if (currentPage < pageCount - 1) {
        scrollToPage(currentPage + 1);
      } else if (nextChapter) {
        window.location.href = `/volume-${volume}/chapter-${nextChapter}`;
      }
    } else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
      e.preventDefault();
      if (currentPage > 0) {
        scrollToPage(currentPage - 1);
      } else if (prevChapter) {
        window.location.href = `/volume-${volume}/chapter-${prevChapter}`;
      }
    }
  });

  const showKeyboardHint = () => {
    keyboardHint.classList.add("opacity-100");
  };

  const hideKeyboardHint = () => {
    keyboardHint.classList.remove("opacity-100");
  };

  updateNavbar();

  setTimeout(() => {
    showKeyboardHint();
    setTimeout(hideKeyboardHint, 3000);
  }, 1000);
</script>
