---
export interface Props {
  volume: number;
  pageCount: number;
  nextChapterNumber: number | null;
  prevChapterNumber: number | null;
}

const { volume, pageCount, nextChapterNumber, prevChapterNumber } = Astro.props;
---

<script
  define:vars={{ pageCount, nextChapterNumber, prevChapterNumber, volume }}
>
  let currentPage = 0;
  const pages = document.querySelectorAll("img[data-page]");
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");
  const pageCounter = document.getElementById("pageCounter");
  const topBar = document.getElementById("topBar");
  let hideTimeout;
  let lastScrollTop = 0;

  function updateUI() {
    pageCounter.textContent = `Pg. ${currentPage + 1} / ${pageCount}`;
    const progress = ((currentPage + 1) / pageCount) * 100;
    progressFill.style.width = `${progress}%`;
  }

  function scrollToPage(index) {
    if (index < 0 || index >= pages.length) return;

    const page = pages[index];

    window.scrollTo({
      top: page.offsetTop,
      behavior: "smooth",
    });

    currentPage = index;
    updateUI();
  }

  function onScroll() {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const middlePoint = scrollTop + windowHeight / 2;

    pages.forEach((page, index) => {
      const rect = page.getBoundingClientRect();
      const pageMiddle = rect.top + window.scrollY + rect.height / 2;

      if (Math.abs(middlePoint - pageMiddle) < rect.height / 2) {
        if (currentPage !== index) {
          currentPage = index;
          updateUI();
        }
      }
    });

    if (scrollTop < lastScrollTop) {
      topBar.classList.remove("-translate-y-full");
      progressBar.classList.remove("-translate-y-24");
    }

    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      topBar.classList.add("-translate-y-full");
      progressBar.classList.add("-translate-y-24");
    }, 3000);

    lastScrollTop = scrollTop;
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "ArrowRight") {
      e.preventDefault();
      if (currentPage < pageCount - 1) {
        scrollToPage(currentPage + 1);
      } else if (nextChapterNumber) {
        window.location.href = `/volume-${volume}/chapter-${nextChapterNumber}`;
      }
    } else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
      e.preventDefault();
      if (currentPage > 0) {
        scrollToPage(currentPage - 1);
      } else if (prevChapterNumber) {
        window.location.href = `/volume-${volume}/chapter-${prevChapterNumber}`;
      }
    }
  });

  document.addEventListener("mousemove", () => {
    topBar.classList.remove("-translate-y-full");
    progressBar.classList.remove("-translate-y-24");
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      topBar.classList.add("-translate-y-full");
      progressBar.classList.add("-translate-y-24");
    }, 3000);
  });

  window.addEventListener("scroll", onScroll);
  updateUI();

  hideTimeout = setTimeout(() => {
    topBar.classList.add("-translate-y-full");
    progressBar.classList.add("-translate-y-24");
  }, 3000);

  setTimeout(() => {
    const hint = document.getElementById("keyboardHint");
    if (hint) {
      hint.classList.add("opacity-100");
      setTimeout(() => {
        hint.classList.remove("opacity-100");
      }, 3000);
    }
  }, 1000);
</script>
