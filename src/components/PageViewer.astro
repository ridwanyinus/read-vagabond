---
export interface Props {
  pagesUrl: string[];
}

const { pagesUrl } = Astro.props;
---

<div class="min-h-screen bg-white flex flex-col items-center pt-20 md:pt-24">
  <div class="w-full max-w-350 flex flex-col items-center">
    {
      pagesUrl.map((pageUrl, index) => (
        <img
          src={pageUrl}
          alt={`Page ${index + 1}`}
          class="h-auto max-h-screen block mb-0.5 object-contain border border-gray-900"
          loading={index < 3 ? "eager" : "lazy"}
          data-page={index}
        />
      ))
    }
  </div>
</div>

<script>
  import {
    currentPage,
    isProgrammaticScroll,
    percentageRead,
  } from "../feature/reader/store";

  const pages = document.querySelectorAll(
    "img[data-page]",
  ) as NodeListOf<HTMLElement>;

  // Called when currentPage is changed through keyboard navigation
  currentPage.subscribe((value) => {
    if (!isProgrammaticScroll.get()) return;

    window.scrollTo({
      top: pages[value].offsetTop,
      behavior: "smooth",
    });

    isProgrammaticScroll.set(false);
    currentPage.set(value);
  });

  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const middlePoint = scrollTop + windowHeight / 2;

    pages.forEach((page, index) => {
      const rect = page.getBoundingClientRect();
      const pageMiddle = rect.top + window.scrollY + rect.height / 2;

      if (Math.abs(middlePoint - pageMiddle) < rect.height / 2) {
        if (currentPage.get() !== index) {
          currentPage.set(index);
          percentageRead.set((index / (pages.length - 1)) * 100);
        }
      }
    });
  });
</script>
