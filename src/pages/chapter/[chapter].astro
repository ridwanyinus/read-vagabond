---
// src/pages/chapter/[chapter].astro
async function fetchJson(endpoint: string) {
  const response = await fetch(`${Astro.url.origin}${endpoint}`);
  return response.json();
}

const { chapter } = Astro.params;

const currentChapter = await fetchJson(`/api/chapters/${chapter}`);
if (!currentChapter) {
  return Astro.redirect("/");
}

const metadata: {
  tankobon: number;
  chapters: number;
} = await fetchJson("/api/metadata");

const chapterNum = parseInt(chapter || "1");
const prevChapter = chapterNum > 1 ? chapterNum - 1 : null;
const nextChapter = chapterNum < metadata.chapters ? chapterNum + 1 : null;

// TODO: Replace with actual page URLs from your database/storage
const pages = [
  "https://imgdump.xyz/Vagabond-Manga/Chapter-1/page-009.webp",
  "https://imgdump.xyz/Vagabond-Manga/Chapter-1/page-010.webp",
  "https://imgdump.xyz/Vagabond-Manga/Chapter-1/page-011.webp",
  "https://imgdump.xyz/Vagabond-Manga/Chapter-1/page-012.webp",
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chapter {currentChapter.number}</title><meta
      name="description"
      content={`Read Vagabond Chapter ${currentChapter.number}: ${currentChapter.title}`}
    /><link rel="preconnect" href="https://fonts.googleapis.com" /><link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    /><link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          sans-serif;
        background: #f5f5f5;
        color: #1a1a1a;
        overflow-x: hidden;
      }

      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 20px;
        z-index: 100;
        transition: transform 0.3s ease;
      }

      .top-bar.hidden {
        transform: translateY(-100%);
      }

      .top-bar-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
      }

      .top-bar-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .top-bar-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .back-btn {
        color: #1a1a1a;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.2s;
      }

      .back-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .chapter-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .chapter-number {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chapter-title {
        font-size: 14px;
        font-weight: 600;
      }

      .page-counter {
        color: #888;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
      }

      .nav-btn {
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        color: #1a1a1a;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        white-space: nowrap;
      }

      .nav-btn:hover:not(:disabled) {
        background: rgba(0, 0, 0, 0.1);
      }

      .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .reader {
        min-height: 100vh;
        background: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 0;
      }

      .pages-container {
        width: 100%;
        max-width: 1400px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .manga-page {
        height: auto;
        max-height: 100vh;
        display: block;
        margin-bottom: 2px;
        object-fit: contain;
        border: #1a1a1a 1px solid;
      }

      .progress-bar {
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        z-index: 99;
        transition: transform 0.3s ease;
      }

      .progress-bar.hidden {
        transform: translateY(-100px);
      }

      .progress-fill {
        height: 100%;
        background: #1a1a1a;
        transition: width 0.1s ease;
      }

      .keyboard-hint {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 13px;
        color: #888;
        opacity: 0;
        pointer-events: none;
        z-index: 101;
        transition: opacity 0.3s ease;
      }

      .keyboard-hint.show {
        opacity: 1;
      }

      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }
        10%,
        90% {
          opacity: 1;
        }
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #888;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .top-bar {
          height: 70px;
          padding: 0 12px;
        }

        .top-bar-row {
          gap: 8px;
        }

        .chapter-title {
          font-size: 12px;
        }

        .chapter-number {
          font-size: 10px;
        }

        .page-counter {
          font-size: 11px;
        }

        .nav-btn {
          padding: 6px 10px;
          font-size: 11px;
        }

        .progress-bar {
          top: 70px;
        }
      }

      html {
        scroll-behavior: smooth;
      }
    </style></head
  >

  <body>
    <div class="top-bar" id="topBar">
      <div class="top-bar-row">
        <div class="top-bar-left">
          <a href="/" class="back-btn">← Back</a>
          <div class="chapter-info">
            <div class="chapter-number">Chapter {currentChapter.number}</div>
            <div class="chapter-title">{currentChapter.title}</div>
          </div>
        </div>
        <div class="top-bar-right">
          <div class="page-counter" id="pageCounter">
            Page 1 / {pages.length}
          </div>
          {
            prevChapter ? (
              <a href={`/chapter/${prevChapter}`} class="nav-btn">
                ← Prev
              </a>
            ) : (
              <button class="nav-btn" disabled>
                ← Prev
              </button>
            )
          }
          {
            nextChapter ? (
              <a href={`/chapter/${nextChapter}`} class="nav-btn">
                Next →
              </a>
            ) : (
              <button class="nav-btn" disabled>
                Next →
              </button>
            )
          }
        </div>
      </div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="reader">
      <div class="pages-container" id="pagesContainer">
        {
          pages.map((pageUrl, index) => (
            <img
              src={pageUrl}
              alt={`Page ${index + 1}`}
              class="manga-page"
              loading={index < 3 ? "eager" : "lazy"}
              data-page={index}
            />
          ))
        }
      </div>
    </div>

    <div class="keyboard-hint" id="keyboardHint">
      Use arrow keys to navigate pages
    </div>

    <script define:vars={{ totalPages: pages.length, nextChapter, prevChapter }}
    >
      let currentPage = 0;
      const pages = document.querySelectorAll(".manga-page");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const pageCounter = document.getElementById("pageCounter");
      const topBar = document.getElementById("topBar");
      let hideTimeout;
      let lastScrollTop = 0;

      function updateUI() {
        pageCounter.textContent = `Page ${currentPage + 1} / ${totalPages}`;
        const progress = ((currentPage + 1) / totalPages) * 100;
        progressFill.style.width = `${progress}%`;
      }

      function scrollToPage(index) {
        if (index < 0 || index >= pages.length) return;

        const page = pages[index];

        window.scrollTo({
          top: page.offsetTop,
          behavior: "smooth",
        });

        currentPage = index;
        updateUI();
      }

      function onScroll() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const middlePoint = scrollTop + windowHeight / 2;

        pages.forEach((page, index) => {
          const rect = page.getBoundingClientRect();
          const pageMiddle = rect.top + window.scrollY + rect.height / 2;

          if (Math.abs(middlePoint - pageMiddle) < rect.height / 2) {
            if (currentPage !== index) {
              currentPage = index;
              updateUI();
            }
          }
        });

        if (scrollTop < lastScrollTop) {
          topBar.classList.remove("hidden");
          progressBar.classList.remove("hidden");
        }

        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          topBar.classList.add("hidden");
          progressBar.classList.add("hidden");
        }, 3000);

        lastScrollTop = scrollTop;
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowDown" || e.key === "ArrowRight") {
          e.preventDefault();
          if (currentPage < totalPages - 1) {
            scrollToPage(currentPage + 1);
          } else if (nextChapter) {
            window.location.href = `/chapter/${nextChapter}`;
          }
        } else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
          e.preventDefault();
          if (currentPage > 0) {
            scrollToPage(currentPage - 1);
          } else if (prevChapter) {
            window.location.href = `/chapter/${prevChapter}`;
          }
        }
      });

      document.addEventListener("mousemove", () => {
        topBar.classList.remove("hidden");
        progressBar.classList.remove("hidden");
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          topBar.classList.add("hidden");
          progressBar.classList.add("hidden");
        }, 3000);
      });

      window.addEventListener("scroll", onScroll);
      updateUI();

      hideTimeout = setTimeout(() => {
        topBar.classList.add("hidden");
        progressBar.classList.add("hidden");
      }, 3000);

      setTimeout(() => {
        const hint = document.getElementById("keyboardHint");
        if (hint) {
          hint.classList.add("show");
          setTimeout(() => {
            hint.classList.remove("show");
          }, 3000);
        }
      }, 1000);
    </script>
  </body>
</html>
