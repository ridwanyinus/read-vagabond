---
import ChapterLayout from "../../../layouts/ChapterLayout.astro";
import { getDb } from "../../../db/client";
import {
  getMangaVolumeByNumber,
  getMangaChapterByNumber,
} from "../../../lib/db";
import { buildPageUrl } from "../../../lib/page";

const { volume: volumeNumber, chapter: chapterNumber } = Astro.params;

if (!volumeNumber || !chapterNumber) {
  return Astro.redirect("/");
}

const db = getDb(Astro.locals.runtime.env.bagabondo_db);
if (!db) {
  throw new Error("Database not configured");
}

const volume = await getMangaVolumeByNumber(db, +volumeNumber);
const chapter = await getMangaChapterByNumber(db, +chapterNumber);

const firstChapter = volume.firstChapter ?? 0;
const lastChapter = volume.lastChapter ?? 0;

if (chapter.number > lastChapter || chapter.number < firstChapter) {
  return Astro.redirect(`/volume-${volumeNumber}`);
}

const prevChapter = chapter.number > firstChapter ? chapter.number - 1 : null;
const nextChapter = chapter.number < lastChapter ? chapter.number + 1 : null;

const pagesUrl = Array.from({ length: chapter.pageCount }, (_, i) =>
  buildPageUrl({
    volume: +volumeNumber,
    chapter: chapter.number,
    page: i + 1,
  }),
);
---

<ChapterLayout
  tagline={`Volume ${volumeNumber} - Chapter ${chapter.number} - ${chapter.title}`}
  metadata={{
    title: `Read Vagabond Manga | Volume ${volumeNumber} - Chapter ${chapter.number} - ${chapter.title}`,
    description: `Read Vagabond Chapter ${chapter.number}: ${chapter.title} online for free. ${chapter.pageCount} pages of high-quality manga from Takehiko Inoue's masterpiece.`,
    keywords: [
      `Vagabond Chapter ${chapter.number}`,
      `${chapter.title}`,
      "read manga online",
      "Takehiko Inoue",
      `Vagabond Volume ${volumeNumber}`,
    ],
    endpoint: `/volume-${volumeNumber}/chapter-${chapter.number}`,
  }}
  volume={+volumeNumber}
  chapter={{
    number: chapter.number,
    title: chapter.title,
    pagesUrl: pagesUrl,
  }}
  prevChapter={prevChapter}
  nextChapter={nextChapter}
/>
