---
import ChapterLayout from "../../../layouts/ChapterLayout.astro";
import { getDb } from "../../../db/client";
import { getMangaVolumeById, getMangaChapterById } from "../../../lib/db";
import { buildPageUrl } from "../../../lib/page";

const { volume: volumeId, chapter: chapterId } = Astro.params;

if (!volumeId || !chapterId) {
  return Astro.redirect("/");
}

const db = getDb(Astro.locals.runtime.env.bagabondo_db);
if (!db) {
  throw new Error("Database not configured");
}

const volume = await getMangaVolumeById(db, +volumeId);
const chapter = await getMangaChapterById(db, +chapterId);

const firstChapter = volume.firstChapter ?? 0;
const lastChapter = volume.lastChapter ?? 0;

const prevChapter = chapter.number > firstChapter ? chapter.number - 1 : null;
const nextChapter = chapter.number < lastChapter ? chapter.number + 1 : null;

const pagesUrl = Array.from({ length: chapter.pageCount }, (_, i) =>
  buildPageUrl({
    volume: +volumeId,
    chapter: chapter.number,
    page: i + 1,
  }),
);
---

<ChapterLayout
  tagline={`Volume ${volumeId} - Chapter ${chapter.number} - ${chapter.title}`}
  metadata={{
    title: `Read Vagabond Manga | Volume ${volumeId} - Chapter ${chapter.number} - ${chapter.title}`,
    description: `Read Vagabond Chapter ${chapter.number}: ${chapter.title} online for free. ${chapter.pageCount} pages of high-quality manga from Takehiko Inoue's masterpiece.`,
    keywords: [
      `Vagabond Chapter ${chapter.number}`,
      `${chapter.title}`,
      "read manga online",
      "Takehiko Inoue",
      `Vagabond Volume ${volumeId}`,
    ],
    endpoint: `/volume-${volumeId}/chapter-${chapter.number}`,
  }}
  volume={+volumeId}
  chapter={{
    number: chapter.number,
    title: chapter.title,
    pagesUrl: pagesUrl,
  }}
  prevChapter={prevChapter}
  nextChapter={nextChapter}
/>
