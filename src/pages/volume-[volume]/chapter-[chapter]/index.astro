---
import ChapterLayout from "../../../layouts/ChapterLayout.astro";
import { getChapterDetails, getMetadata } from "../../../lib/db";

const { volume, chapter } = Astro.params;

if (!volume || !chapter) {
  return Astro.redirect("/");
}

const db = Astro.locals.runtime?.env?.vagabond_db;
if (!db) {
  throw new Error("Database not configured");
}

const currentChapter = await getChapterDetails(db, chapter);
if (!currentChapter) {
  return Astro.redirect("/");
}

const metadata = await getMetadata(db);

const chapterNum = parseInt(chapter || "1");
const prevChapter = chapterNum > 1 ? chapterNum - 1 : null;
const nextChapter = chapterNum < metadata.chapters ? chapterNum + 1 : null;

const pages = Array.from(
  { length: currentChapter.page_count },
  (_, i) => i + 1,
).map((pageNumber) => {
  const volumeStr = volume?.padStart(2, "0");
  const numberStr = currentChapter.number.toString().padStart(3, "0");
  const pageStr = pageNumber.toString().padStart(3, "0");
  return `https://bucket.readbagabondo.com/volume-${volumeStr}/chapter-${numberStr}/page-${pageStr}.png`;
});
---

<ChapterLayout
  tagline={`Volume ${volume} - Chapter ${currentChapter.number} - ${currentChapter.title}`}
  metadata={{
    title: `Read Vagabond Manga | Volume ${volume} - Chapter ${currentChapter.number} - ${currentChapter.title}`,
    description: `Read Vagabond Chapter ${currentChapter.number}: ${currentChapter.title} online for free. ${currentChapter.page_count} pages of high-quality manga from Takehiko Inoue's masterpiece.`,
    keywords: [
      `Vagabond Chapter ${currentChapter.number}`,
      `${currentChapter.title}`,
      "read manga online",
      "Takehiko Inoue",
      `Vagabond Volume ${volume}`,
    ],
    endpoint: `/volume-${volume}/chapter-${currentChapter.number}`,
  }}
  volume={parseInt(volume)}
  chapter={{
    number: currentChapter.number,
    title: currentChapter.title,
    pagesUrl: pages,
  }}
  prevChapter={prevChapter}
  nextChapter={nextChapter}
/>
