---
import ChapterList from "../../components/ChapterList.astro";
import VolumeCover from "../../components/VolumeCover.astro";
import VolumeInformation from "../../components/VolumeInformation.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import { getVolumeDetails } from "../../lib/db";

const { volume } = Astro.params;

if (!volume) {
  return Astro.redirect("/");
}

const db = Astro.locals.runtime?.env?.vagabond_db;
if (!db) {
  throw new Error("Database not configured");
}

const data = await getVolumeDetails(db, volume);
if (!data) {
  return Astro.redirect("/");
}

// Confusing. Migrate to query database instead.
const coverUrl = `https://bucket.readbagabondo.com/covers/volume-${data.volume.volume.toString().padStart(2, "0")}.jpg`;
---

<MainLayout
  tagline={`Volume ${data.volume.volume}`}
  metadata={{
    title: `Read Vagabond Manga | Volume ${data.volume.volume}`,
    description: `Read Vagabond Volume ${data.volume.volume} online for free. Contains ${data.volume.chapter_count} chapters (${data.volume.first_chapter}-${data.volume.last_chapter}). High-quality manga scans from Takehiko Inoue's masterpiece.`,
    keywords: [
      `Vagabond Volume ${data.volume.volume}`,
      `Vagabond chapters ${data.volume.first_chapter}-${data.volume.last_chapter}`,
      "Takehiko Inoue",
      "read manga online",
    ],
    endpoint: `/volume-${data.volume.volume}`,
  }}
>
  <main class="pt-20">
    <section class="bg-white border-b border-gray-200 min-h-[calc(100vh-5rem)]">
      <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-[auto_1fr] gap-15 h-full">
          <div class="flex flex-col lg:w-80">
            <VolumeCover url={coverUrl} volume={data.volume.volume} />
            <VolumeInformation
              volume={data.volume.volume}
              chapterCount={data.volume.chapter_count}
              firstChapter={data.volume.first_chapter}
              lastChapter={data.volume.last_chapter}
              releaseDate={data.volume.release_date}
            />
          </div>
          <ChapterList volume={data.volume} chapters={data.chapters} />
        </div>
      </div>
    </section>
  </main>
</MainLayout>
