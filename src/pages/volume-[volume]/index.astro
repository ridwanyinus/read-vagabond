---
import ChapterList from "../../components/ChapterList.astro";
import VolumeCover from "../../components/VolumeCover.astro";
import VolumeInformation from "../../components/VolumeInformation.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import { getDb } from "../../db/client";
import { getMangaVolumeById, getMangaChaptersByVolumeId } from "../../lib/db";

const { volume: volumeId } = Astro.params;

if (!volumeId) {
  return Astro.redirect("/");
}

const db = getDb(Astro.locals.runtime?.env?.bagabondo_db);
if (!db) {
  throw new Error("Database not configured");
}

const volume = await getMangaVolumeById(db, +volumeId);
const chaptersFromVolume = await getMangaChaptersByVolumeId(db, +volumeId);
---

<MainLayout
  tagline={`Volume ${volume.number}`}
  metadata={{
    title: `Read Vagabond Manga | Volume ${volume.number}`,
    description: `Read Vagabond Volume ${volume.number} online for free. Contains ${volume.chapterCount} chapters (${volume.firstChapter}-${volume.lastChapter}). High-quality manga scans from Takehiko Inoue's masterpiece.`,
    keywords: [
      `Vagabond Volume ${volume.number}`,
      `Vagabond chapters ${volume.firstChapter}-${volume.lastChapter}`,
      "Takehiko Inoue",
      "read manga online",
    ],
    endpoint: `/volume-${volume.number}`,
  }}
>
  <main class="pt-20">
    <section class="bg-white border-b border-gray-200 min-h-[calc(100vh-5rem)]">
      <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-[auto_1fr] gap-15 h-full">
          <div class="flex flex-col lg:w-80">
            <VolumeCover volume={volume.number} />
            <VolumeInformation
              volume={volume.number}
              chapterCount={volume.chapterCount}
              firstChapter={volume.firstChapter}
              lastChapter={volume.lastChapter}
              releaseDate={volume.releaseDate}
            />
          </div>
          <ChapterList
            volumeNumber={volume.number}
            chapters={chaptersFromVolume}
          />
        </div>
      </div>
    </section>
  </main>
</MainLayout>
